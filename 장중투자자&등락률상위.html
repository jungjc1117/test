<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Kiwoom 장중투자자별매매상위요청</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #333;
      }
      #timestamp {
        text-align: right;
        font-size: 0.9em;
        color: #777;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9em;
      }
      th,
      td {
        /* padding: 12px; */
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
        color: #555;
      }
      tr:hover {
        background-color: #f9f9f9;
      }
      .loading {
        text-align: center;
        color: #888;
      }
      .error {
        color: red;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>키움증권 장중투자자별매매상위요청</h1>
      <div id="timestamp"></div>
      <div id="output"></div>
    </div>

    <script>
      const accessParams = {
        grant_type: "client_credentials",
        appkey: "oJ5S3eaEUVsSaxPX7vkiOPjOI9_yvkFGm3lwAkd_fAg",
        secretkey: "lA1nom_3Ql1TX1rUpppvwhRJBuEQ44cECAYn7lCGgps",
      };

      const fluKospiUp = {
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        sort_tp: "1", //1:상승률, 2:상승폭, 3:하락률, 4:하락폭, 5:보합
        trde_qty_cnd: "0000", //0000:전체조회, 0010:만주이상, 0050:5만주이상, 0100:10만주이상, 0150:15만주이상, 0200:20만주이상, 0300:30만주이상, 0500:50만주이상, 1000:백만주이상
        stk_cnd: "0", //0:전체조회, 1:관리종목제외, 4:우선주+관리주제외, 3:우선주제외, 5:증100제외, 6:증100만보기, 7:증40만보기, 8:증30만보기, 9:증20만보기, 11:정리매매종목제외, 12:증50만보기, 13:증60만보기, 14:ETF제외, 15:스펙제외, 16:ETF+ETN제외
        crd_cnd: "0", //0:전체조회, 1:신용융자A군, 2:신용융자B군, 3:신용융자C군, 4:신용융자D군, 7:신용융자E군, 9:신용융자전체
        updown_incls: "1", //0:불 포함, 1:포함
        pric_cnd: "0", //0:전체조회, 1:1천원미만, 2:1천원~2천원, 3:2천원~5천원, 4:5천원~1만원, 5:1만원이상, 8:1천원이상, 10: 1만원미만
        trde_prica_cnd: "0", //0:전체조회, 3:3천만원이상, 5:5천만원이상, 10:1억원이상, 30:3억원이상, 50:5억원이상, 100:10억원이상, 300:30억원이상, 500:50억원이상, 1000:100억원이상, 3000:300억원이상, 5000:500억원이상
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };

      const fluKosdaqUp = {
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        sort_tp: "1", //1:상승률, 2:상승폭, 3:하락률, 4:하락폭, 5:보합
        trde_qty_cnd: "0000", //0000:전체조회, 0010:만주이상, 0050:5만주이상, 0100:10만주이상, 0150:15만주이상, 0200:20만주이상, 0300:30만주이상, 0500:50만주이상, 1000:백만주이상
        stk_cnd: "0", //0:전체조회, 1:관리종목제외, 4:우선주+관리주제외, 3:우선주제외, 5:증100제외, 6:증100만보기, 7:증40만보기, 8:증30만보기, 9:증20만보기, 11:정리매매종목제외, 12:증50만보기, 13:증60만보기, 14:ETF제외, 15:스펙제외, 16:ETF+ETN제외
        crd_cnd: "0", //0:전체조회, 1:신용융자A군, 2:신용융자B군, 3:신용융자C군, 4:신용융자D군, 7:신용융자E군, 9:신용융자전체
        updown_incls: "1", //0:불 포함, 1:포함
        pric_cnd: "0", //0:전체조회, 1:1천원미만, 2:1천원~2천원, 3:2천원~5천원, 4:5천원~1만원, 5:1만원이상, 8:1천원이상, 10: 1만원미만
        trde_prica_cnd: "0", //0:전체조회, 3:3천만원이상, 5:5천만원이상, 10:1억원이상, 30:3억원이상, 50:5억원이상, 100:10억원이상, 300:30억원이상, 500:50억원이상, 1000:100억원이상, 3000:300억원이상, 5000:500억원이상
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };
      const fluKospiDown = {
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        sort_tp: "3", //1:상승률, 2:상승폭, 3:하락률, 4:하락폭, 5:보합
        trde_qty_cnd: "0000", //0000:전체조회, 0010:만주이상, 0050:5만주이상, 0100:10만주이상, 0150:15만주이상, 0200:20만주이상, 0300:30만주이상, 0500:50만주이상, 1000:백만주이상
        stk_cnd: "0", //0:전체조회, 1:관리종목제외, 4:우선주+관리주제외, 3:우선주제외, 5:증100제외, 6:증100만보기, 7:증40만보기, 8:증30만보기, 9:증20만보기, 11:정리매매종목제외, 12:증50만보기, 13:증60만보기, 14:ETF제외, 15:스펙제외, 16:ETF+ETN제외
        crd_cnd: "0", //0:전체조회, 1:신용융자A군, 2:신용융자B군, 3:신용융자C군, 4:신용융자D군, 7:신용융자E군, 9:신용융자전체
        updown_incls: "1", //0:불 포함, 1:포함
        pric_cnd: "0", //0:전체조회, 1:1천원미만, 2:1천원~2천원, 3:2천원~5천원, 4:5천원~1만원, 5:1만원이상, 8:1천원이상, 10: 1만원미만
        trde_prica_cnd: "0", //0:전체조회, 3:3천만원이상, 5:5천만원이상, 10:1억원이상, 30:3억원이상, 50:5억원이상, 100:10억원이상, 300:30억원이상, 500:50억원이상, 1000:100억원이상, 3000:300억원이상, 5000:500억원이상
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };
      const fluKosdaqDown = {
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        sort_tp: "3", //1:상승률, 2:상승폭, 3:하락률, 4:하락폭, 5:보합
        trde_qty_cnd: "0000", //0000:전체조회, 0010:만주이상, 0050:5만주이상, 0100:10만주이상, 0150:15만주이상, 0200:20만주이상, 0300:30만주이상, 0500:50만주이상, 1000:백만주이상
        stk_cnd: "0", //0:전체조회, 1:관리종목제외, 4:우선주+관리주제외, 3:우선주제외, 5:증100제외, 6:증100만보기, 7:증40만보기, 8:증30만보기, 9:증20만보기, 11:정리매매종목제외, 12:증50만보기, 13:증60만보기, 14:ETF제외, 15:스펙제외, 16:ETF+ETN제외
        crd_cnd: "0", //0:전체조회, 1:신용융자A군, 2:신용융자B군, 3:신용융자C군, 4:신용융자D군, 7:신용융자E군, 9:신용융자전체
        updown_incls: "1", //0:불 포함, 1:포함
        pric_cnd: "0", //0:전체조회, 1:1천원미만, 2:1천원~2천원, 3:2천원~5천원, 4:5천원~1만원, 5:1만원이상, 8:1천원이상, 10: 1만원미만
        trde_prica_cnd: "0", //0:전체조회, 3:3천만원이상, 5:5천만원이상, 10:1억원이상, 30:3억원이상, 50:5억원이상, 100:10억원이상, 300:30억원이상, 500:50억원이상, 1000:100억원이상, 3000:300억원이상, 5000:500억원이상
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };
      const fluKospiSame = {
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        sort_tp: "5", //1:상승률, 2:상승폭, 3:하락률, 4:하락폭, 5:보합
        trde_qty_cnd: "0000", //0000:전체조회, 0010:만주이상, 0050:5만주이상, 0100:10만주이상, 0150:15만주이상, 0200:20만주이상, 0300:30만주이상, 0500:50만주이상, 1000:백만주이상
        stk_cnd: "0", //0:전체조회, 1:관리종목제외, 4:우선주+관리주제외, 3:우선주제외, 5:증100제외, 6:증100만보기, 7:증40만보기, 8:증30만보기, 9:증20만보기, 11:정리매매종목제외, 12:증50만보기, 13:증60만보기, 14:ETF제외, 15:스펙제외, 16:ETF+ETN제외
        crd_cnd: "0", //0:전체조회, 1:신용융자A군, 2:신용융자B군, 3:신용융자C군, 4:신용융자D군, 7:신용융자E군, 9:신용융자전체
        updown_incls: "1", //0:불 포함, 1:포함
        pric_cnd: "0", //0:전체조회, 1:1천원미만, 2:1천원~2천원, 3:2천원~5천원, 4:5천원~1만원, 5:1만원이상, 8:1천원이상, 10: 1만원미만
        trde_prica_cnd: "0", //0:전체조회, 3:3천만원이상, 5:5천만원이상, 10:1억원이상, 30:3억원이상, 50:5억원이상, 100:10억원이상, 300:30억원이상, 500:50억원이상, 1000:100억원이상, 3000:300억원이상, 5000:500억원이상
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };
      const fluKosdaqSame = {
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        sort_tp: "5", //1:상승률, 2:상승폭, 3:하락률, 4:하락폭, 5:보합
        trde_qty_cnd: "0000", //0000:전체조회, 0010:만주이상, 0050:5만주이상, 0100:10만주이상, 0150:15만주이상, 0200:20만주이상, 0300:30만주이상, 0500:50만주이상, 1000:백만주이상
        stk_cnd: "0", //0:전체조회, 1:관리종목제외, 4:우선주+관리주제외, 3:우선주제외, 5:증100제외, 6:증100만보기, 7:증40만보기, 8:증30만보기, 9:증20만보기, 11:정리매매종목제외, 12:증50만보기, 13:증60만보기, 14:ETF제외, 15:스펙제외, 16:ETF+ETN제외
        crd_cnd: "0", //0:전체조회, 1:신용융자A군, 2:신용융자B군, 3:신용융자C군, 4:신용융자D군, 7:신용융자E군, 9:신용융자전체
        updown_incls: "1", //0:불 포함, 1:포함
        pric_cnd: "0", //0:전체조회, 1:1천원미만, 2:1천원~2천원, 3:2천원~5천원, 4:5천원~1만원, 5:1만원이상, 8:1천원이상, 10: 1만원미만
        trde_prica_cnd: "0", //0:전체조회, 3:3천만원이상, 5:5천만원이상, 10:1억원이상, 30:3억원이상, 50:5억원이상, 100:10억원이상, 300:30억원이상, 500:50억원이상, 1000:100억원이상, 3000:300억원이상, 5000:500억원이상
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };

      const ForKospiBuy = {
        trde_tp: "1", //1:순매수, 2:순매도
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9000", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const ForKosdaqBuy = {
        trde_tp: "1", //1:순매수, 2:순매도
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9000", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const OrgKospiBuy = {
        trde_tp: "1", //1:순매수, 2:순매도
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9999", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const OrgKosdaqBuy = {
        trde_tp: "1", //1:순매수, 2:순매도
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9999", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const ForKospiSell = {
        trde_tp: "2", //1:순매수, 2:순매도
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9000", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const ForKosdaqSell = {
        trde_tp: "2", //1:순매수, 2:순매도
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9000", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const OrgKospiSell = {
        trde_tp: "2", //1:순매수, 2:순매도
        mrkt_tp: "001", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9999", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      const OrgKosdaqSell = {
        trde_tp: "2", //1:순매수, 2:순매도
        mrkt_tp: "101", //000:전체, 001:코스피, 101:코스닥
        orgn_tp: "9999", //9000:외국인, 9100:외국계, 1000:금융투자, 3000:투신, 5000:기타금융, 4000:은행, 2000:보험, 6000:연기금, 7000:국가, 7100:기타법인, 9999:기관계
      };

      async function fetchToken() {
        const url = "https://mockapi.kiwoom.com/oauth2/token";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json;charset=UTF-8" },
          body: JSON.stringify(accessParams),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data.token;
      }

      // Helper function to create a delay
      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function fetchflu(token, params) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10027",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(params),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return (data.pred_pre_flu_rt_upper || []).map((item) => ({
          stk_cd: item.stk_cd.replace(/^A|_AL$/, ""),
          stk_nm: item.stk_nm,
          cur_prc: Math.abs(parseInt(item.cur_prc)),
          flu_rt: parseFloat(item.flu_rt),
          now_trde_qty: parseInt(item.now_trde_qty),
        }));
      }

      async function fetchInvestorData(token, params) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10065",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(params),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data.opmr_invsr_trde_upper || [];
      }

      function renderTable(dataList) {
        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>종목코드</th>
              <th>종목명</th>
              <th>현재가</th>
              <th>등락률</th>
              <th>거래량</th>
              <th>외인매수</th>
              <th>외국매도</th>
              <th>외국순매수</th>
              <th>기관매수</th>
              <th>기관매도</th>
              <th>기관순매수</th>
              <th>양매수</th>
            </tr>
          </thead>
          <tbody>
            ${dataList
              .map(
                (item) => `
              <tr>
                <td>${item.stk_cd}</td>
                <td>${item.stk_nm}</td>
                <td>${item.cur_prc}</td>
                <td>${
                  item.flu_rt !== undefined ? item.flu_rt.toFixed(2) : ""
                }</td>
                <td>${item.now_trde_qty}</td>
                <td>${item.ForNetBuy || ""}</td>
                <td>${item.ForNetSell || ""}</td>
                <td>${
                  item.ForNetBuy !== undefined && item.ForNetSell !== undefined
                    ? item.ForNetBuy - item.ForNetSell
                    : ""
                }</td>
                <td>${item.OrgNetBuy || ""}</td>
                <td>${item.OrgNetSell || ""}</td>
                <td>${
                  item.OrgNetBuy !== undefined && item.OrgNetSell !== undefined
                    ? item.OrgNetBuy - item.OrgNetSell
                    : ""
                }</td>
                <td>${
                  item.ForNetBuy !== undefined &&
                  item.ForNetSell !== undefined &&
                  item.OrgNetBuy !== undefined &&
                  item.OrgNetSell !== undefined
                    ? item.ForNetBuy -
                      item.ForNetSell +
                      item.OrgNetBuy -
                      item.OrgNetSell
                    : ""
                }</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        `;
        document.getElementById("output").innerHTML = "";
        document.getElementById("output").appendChild(table);
      }

      function updateTimestamp(message = "") {
        const now = new Date();
        document.getElementById(
          "timestamp"
        ).innerText = `${message} 최종 업데이트: ${now.toLocaleTimeString()}`;
      }

      async function updateData() {
        try {
          updateTimestamp("업데이트 중... ");

          const token = await fetchToken();
          const mergedDataMap = new Map();

          // Fetch Foreigner Kospi Buy data
          const forKospiBuyData = await fetchInvestorData(token, ForKospiBuy);
          forKospiBuyData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            existingItem.ForNetBuy = parseInt(item.netslmt);
          });
          await delay(1000);

          // Fetch Foreigner Kosdaq data
          const forKosdaqBuyData = await fetchInvestorData(token, ForKosdaqBuy);
          forKosdaqBuyData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem.ForNetBuy) {
              existingItem.ForNetBuy = `${existingItem.ForNetBuy} / ${item.netslmt}`;
            } else {
              existingItem.ForNetBuy = parseInt(item.netslmt);
            }
          });
          await delay(1000);

          // Fetch Institution Kospi data
          const orgKospiBuyData = await fetchInvestorData(token, OrgKospiBuy);
          orgKospiBuyData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            existingItem.OrgNetBuy = parseInt(item.netslmt);
          });
          await delay(1000);

          // Fetch Institution Kosdaq data
          const orgKosdaqBuyData = await fetchInvestorData(token, OrgKosdaqBuy);
          orgKosdaqBuyData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem.OrgNetBuy) {
              existingItem.OrgNetBuy = `${existingItem.OrgNetBuy} / ${item.netslmt}`;
            } else {
              existingItem.OrgNetBuy = parseInt(item.netslmt);
            }
          });
          await delay(1000);

          // Fetch Foreigner Kospi Sell data
          const forKospiSellData = await fetchInvestorData(token, ForKospiSell);
          forKospiSellData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            existingItem.ForNetSell = parseInt(item.netslmt);
          });
          await delay(1000);

          // Fetch Foreigner Kosdaq data
          const forKosdaqSellData = await fetchInvestorData(
            token,
            ForKosdaqSell
          );
          forKosdaqSellData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem.ForNetSell) {
              existingItem.ForNetSell = `${existingItem.ForNetSell} / ${item.netslmt}`;
            } else {
              existingItem.ForNetSell = parseInt(item.netslmt);
            }
          });
          await delay(1000);

          // Fetch Institution Kospi data
          const orgKospiSellData = await fetchInvestorData(token, OrgKospiSell);
          orgKospiSellData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            existingItem.OrgNetSell = parseInt(item.netslmt);
          });
          await delay(1000);

          // Fetch Institution Kosdaq data
          const orgKosdaqSellData = await fetchInvestorData(
            token,
            OrgKosdaqSell
          );
          orgKosdaqSellData.forEach((item) => {
            if (!mergedDataMap.has(item.stk_cd)) {
              mergedDataMap.set(item.stk_cd, {
                stk_cd: item.stk_cd,
                stk_nm: item.stk_nm,
              });
            }
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem.OrgNetSell) {
              existingItem.OrgNetSell = `${existingItem.OrgNetSell} / ${item.netslmt}`;
            } else {
              existingItem.OrgNetSell = parseInt(item.netslmt);
            }
          });
          await delay(1000);

          // Fetch Kospi Up data
          const fluKospiUpData = await fetchflu(token, fluKospiUp);
          fluKospiUpData.forEach((item) =>
            mergedDataMap.set(item.stk_cd, item)
          );
          await delay(1000);

          // Fetch Kosdaq Up data
          const fluKosdaqUpData = await fetchflu(token, fluKosdaqUp);
          fluKosdaqUpData.forEach((item) =>
            mergedDataMap.set(item.stk_cd, item)
          );
          await delay(1000);

          // Fetch Kospi Down data
          const fluKospiDownData = await fetchflu(token, fluKospiDown);
          fluKospiDownData.forEach((item) =>
            mergedDataMap.set(item.stk_cd, item)
          );
          await delay(1000);

          // Fetch Kosdaq Down data
          const fluKosdaqDownData = await fetchflu(token, fluKosdaqDown);
          fluKosdaqDownData.forEach((item) =>
            mergedDataMap.set(item.stk_cd, item)
          );
          await delay(1000);

          // Fetch Kospi Down data
          const fluKospiSameData = await fetchflu(token, fluKospiSame);
          fluKospiSameData.forEach((item) =>
            mergedDataMap.set(item.stk_cd, item)
          );
          await delay(1000);

          // Fetch Kosdaq Down data
          const fluKosdaqSameData = await fetchflu(token, fluKosdaqSame);
          fluKosdaqSameData.forEach((item) =>
            mergedDataMap.set(item.stk_cd, item)
          );

          const finalData = Array.from(mergedDataMap.values());
          renderTable(finalData);
          updateTimestamp();
        } catch (e) {
          console.error("Error during updateData:", e);
          document.getElementById(
            "output"
          ).innerHTML = `<div class="error">데이터 로딩 중 에러가 발생했습니다: ${e.message}</div>`;
        }
      }

      updateData();
      setInterval(updateData, 60000); // 10초마다 업데이트
    </script>
  </body>
</html>
