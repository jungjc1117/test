<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>계좌평가잔고내역</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 600px;
        margin: auto;
        background: white;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      #timestamp {
        text-align: right;
        font-size: 0.9em;
        color: #777;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
        color: #555;
      }
      tr:hover {
        background-color: #f9f9f9;
      }
      .loading {
        text-align: center;
        color: #888;
      }
      .error {
        color: red;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="timestamp"></div>
      <div id="output"></div>
    </div>

    <script>
      const accessParams = {
        grant_type: "client_credentials",
        appkey: "oJ5S3eaEUVsSaxPX7vkiOPjOI9_yvkFGm3lwAkd_fAg",
        secretkey: "lA1nom_3Ql1TX1rUpppvwhRJBuEQ44cECAYn7lCGgps",
      };

      const chartParams5 = {
        qry_tp: "2", // 1:합산, 2:개별
        dmst_stex_tp: "KRX", // KRX:한국거래소,NXT:넥스트트레이드
      };

      async function fetchToken() {
        const url = "https://mockapi.kiwoom.com/oauth2/token";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json;charset=UTF-8" },
          body: JSON.stringify(accessParams),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data.token;
      }

      async function fetchAccount(token) {
        const url = "https://mockapi.kiwoom.com/api/dostk/acnt";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "kt00018",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(chartParams5),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data.acnt_evlt_remn_indv_tot || [];
      }

      async function ordersell(stk_cd, quantity) {
        const cleanedStkCd = stk_cd.replace(/^A/, "");

        const chartParams5 = {
          dmst_stex_tp: "KRX",
          stk_cd: cleanedStkCd, // 변환된 종목 코드를 사용
          ord_qty: quantity.toString(),
          trde_tp: "3",
          cond_uv: "",
        };

        try {
          const token = await fetchToken();
          const url = "https://mockapi.kiwoom.com/api/dostk/ordr";
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json;charset=UTF-8",
              authorization: `Bearer ${token}`,
              "api-id": "kt10001",
              "cont-yn": "N",
              "next-key": "",
            },
            body: JSON.stringify(chartParams5),
          });

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();
          console.log("주문 응답:", data);
          alert(
            `${stk_cd} 종목에 대해 ${quantity}주 주문이 성공적으로 전송되었습니다.`
          );
        } catch (e) {
          console.error("주문 실패:", e);
          alert(`주문 실패: ${e.message}`);
        }
      }

      function renderTable1(dataList) {
        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>종목번호</th>
              <th>종목명</th>
              <th>수익률(%)</th>
              <th>매입가</th>
              <th>현재가</th>
              <th>보유수량</th>
              <th>매도</th>
            </tr>
          </thead>
          <tbody>
            ${dataList
              .map(
                (item) => `
              <tr>
                <td>${item.stk_cd.replace(/[^0-9]/g, "")}</td>
                <td>${item.stk_nm}</td>
                <td>${parseFloat(item.prft_rt).toFixed(2)}</td>
                <td>${parseInt(item.pur_pric, 10).toString()}</td>
                <td>${parseInt(item.cur_prc, 10).toString()}</td>
                <td>${parseInt(item.rmnd_qty, 10).toString()}</td>
                <td>
                        <button onclick="ordersell('${item.stk_cd}', ${parseInt(
                  item.rmnd_qty,
                  10
                ).toString()})">
                            매도
                        </button>
                    </td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        `;
        document.getElementById("output").innerHTML = "";
        document.getElementById("output").appendChild(table);
      }

      function updateTimestamp() {
        const now = new Date();
        document.getElementById(
          "timestamp"
        ).innerText = `최종 업데이트: ${now.toLocaleTimeString()}`;
      }

      async function updateData1() {
        try {
          document.getElementById(
            "output"
          ).innerHTML = `<div class="loading">데이터 불러오는 중...</div>`;
          const token = await fetchToken();
          const stockList = await fetchAccount(token);

          if (!stockList || stockList.length === 0) {
            document.getElementById(
              "output"
            ).innerHTML = `<div class="error">API에서 데이터를 가져오지 못했습니다.</div>`;
            return;
          }

          renderTable1(stockList);
        } catch (e) {
          console.error("Error during updateData:", e);
          document.getElementById(
            "output"
          ).innerHTML = `<div class="error">데이터 로딩 중 에러가 발생했습니다: ${e.message}</div>`;
        }
      }

      // Initial data load and periodic updates
      updateData1();
    </script>
  </body>
</html>
