<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì‹¤ì‹œê°„ ì£¼ê°€ ë°ì´í„° í…Œì´ë¸”</title>
    <style>
      /* ì›¹ì†Œì¼“ ìˆ˜ì‹  ë°ì´í„°ë¥¼ í‘œì‹œí•  ê°„ë‹¨í•œ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
      #stock-table {
        width: 80%;
        margin: 20px auto;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
      }
      #stock-table th,
      #stock-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: right;
      }
      #stock-table th {
        background-color: #f2f2f2;
        text-align: left;
      }
      .positive {
        color: green;
        font-weight: bold;
      }
      .negative {
        color: red;
        font-weight: bold;
      }
      .status-bar {
        text-align: center;
        margin-bottom: 10px;
        font-size: 1.1em;
      }
    </style>
  </head>
  <body>
    <div class="status-bar">
      ì›¹ì†Œì¼“ ìƒíƒœ: <span id="ws-status">ì—°ê²° ì‹œë„ ì¤‘...</span>
    </div>

    <table id="stock-table">
      <thead>
        <tr>
          <th>ì¢…ëª©ëª…</th>
          <th>í˜„ì¬ê°€</th>
          <th>ë³€ë™ ($)</th>
          <th>ë³€ë™ë¥  (%)</th>
          <th>ê±°ë˜ëŸ‰</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr>
          <td colspan="5">ë°ì´í„° ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...</td>
        </tr>
      </tbody>
    </table>

    <script>
      // --- 1. ê°€ìƒ Access Token ë°œê¸‰ í•¨ìˆ˜ (í† í° ë¡œì§ ê°€ì •) ---
      function getAccessToken() {
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ì—ì„œ í† í°ì„ ë°›ì•„ì˜¤ê±°ë‚˜, ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ì½ì–´ì˜µë‹ˆë‹¤.
        console.log("Access Token ë°œê¸‰ (ê°€ìƒ)...");
        return "Bearer_FAKE_ACCESS_TOKEN_1234567890";
      }

      // --- 2. ì›¹ì†Œì¼“ ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ---
      function connectWebSocket() {
        const token = getAccessToken();

        // ì‹¤ì œ ì›¹ì†Œì¼“ URLê³¼ ì¸ì¦ í† í°ì„ í¬í•¨í•œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
        // (ì°¸ê³ : ì›¹ì†Œì¼“ í‘œì¤€ì€ í—¤ë”ë¥¼ í†µí•œ í† í° ì „ì†¡ì„ ì§€ì›í•˜ì§€ ì•Šì•„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë§ì´ ì‚¬ìš©)
        const wsUrl = `ws://localhost:8080/ws/realtime-data?token=${token
          .split("_")
          .pop()}`;
        const ws = new WebSocket(wsUrl);
        const tableBody = document.getElementById("table-body");
        const statusElement = document.getElementById("ws-status");

        // ì—°ê²° ì´ë²¤íŠ¸
        ws.onopen = () => {
          statusElement.textContent = "ì—°ê²° ì„±ê³µ! ğŸŸ¢";
          console.log("WebSocket ì—°ê²° ì„±ê³µ. Access Token ì „ì†¡ ì™„ë£Œ.");
          // ì„œë²„ì— êµ¬ë… ë©”ì‹œì§€ ì „ì†¡ (ì˜ˆì‹œ)
          ws.send(
            JSON.stringify({
              action: "subscribe",
              symbols: ["AAPL", "MSFT", "GOOG"],
            })
          );
        };

        // ë©”ì‹œì§€ ìˆ˜ì‹  ì´ë²¤íŠ¸ (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„)
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);

          // ìˆ˜ì‹ ëœ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸
          updateTable(data.stocks || [data]);
        };

        // ì—ëŸ¬ ì´ë²¤íŠ¸
        ws.onerror = (error) => {
          statusElement.textContent = "ì—ëŸ¬ ë°œìƒ ğŸ”´";
          console.error("WebSocket Error:", error);
        };

        // ì—°ê²° ì¢…ë£Œ ì´ë²¤íŠ¸
        ws.onclose = () => {
          statusElement.textContent = "ì—°ê²° ì¢…ë£Œ ğŸŸ¡. 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...";
          console.log("WebSocket ì—°ê²° ì¢…ë£Œ.");
          // ì¼ì • ì‹œê°„ í›„ ì¬ì—°ê²° ì‹œë„
          setTimeout(connectWebSocket, 5000);
        };
      }

      // --- 3. í…Œì´ë¸” UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ì˜ ì—­í• ) ---
      // ì´ í•¨ìˆ˜ëŠ” ê¸°ì¡´ JS ì½”ë“œì˜ í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸(e.g., <j.A>)ê°€ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ
      // HTML ìš”ì†Œë¥¼ ì¡°ì‘í•˜ëŠ” ì—­í• ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤.
      function updateTable(stocks) {
        const body = document.getElementById("table-body");
        body.innerHTML = ""; // í…Œì´ë¸” ë‚´ìš© ì´ˆê¸°í™”

        stocks.forEach((stock) => {
          const row = body.insertRow();

          // ë°ì´í„°ì—ì„œ í•„ìš”í•œ í•„ë“œ ì¶”ì¶œ (ê¸°ì¡´ ì½”ë“œ êµ¬ì¡° ì°¸ì¡°)
          const symbol = stock.symbol || "N/A";
          const last = stock.last || "0.00";
          const change = stock.changeAsNumber || 0;
          const changePercent = stock.changePercentAsNumber || 0;
          const volume = stock.volumeAbbreviated || "0K";

          // ë³€ë™ë¥ ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ê²°ì •
          const changeClass =
            change > 0 ? "positive" : change < 0 ? "negative" : "";

          // ì…€ ì¶”ê°€ ë° ë°ì´í„° ì‚½ì…
          row.insertCell().textContent = symbol;
          row.insertCell().textContent = last;

          const changeCell = row.insertCell();
          changeCell.textContent = change.toFixed(2);
          changeCell.classList.add(changeClass);

          const percentCell = row.insertCell();
          percentCell.textContent = `${changePercent.toFixed(2)}%`;
          percentCell.classList.add(changeClass);

          row.insertCell().textContent = volume;
        });
      }

      // --- 4. ì´ˆê¸° ì‹¤í–‰ ---
      // ê°€ìƒì˜ ì´ˆê¸° ë°ì´í„°ë¡œ í…Œì´ë¸”ì„ ì±„ìš°ê³ , ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
      const initialFakeData = [
        {
          symbol: "AAPL",
          last: "175.20",
          changeAsNumber: 1.5,
          changePercentAsNumber: 0.86,
          volumeAbbreviated: "15M",
        },
        {
          symbol: "MSFT",
          last: "405.50",
          changeAsNumber: -0.8,
          changePercentAsNumber: -0.2,
          volumeAbbreviated: "12M",
        },
        {
          symbol: "GOOG",
          last: "150.10",
          changeAsNumber: 0.0,
          changePercentAsNumber: 0.0,
          volumeAbbreviated: "5M",
        },
      ];
      updateTable(initialFakeData);
      connectWebSocket(); // ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘

      // ê°€ìƒ ë©”ì‹œì§€ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” ws.onmessageì—ì„œ ìˆ˜ì‹ ë¨)
      setTimeout(() => {
        updateTable([
          {
            symbol: "AAPL",
            last: "175.90",
            changeAsNumber: 2.2,
            changePercentAsNumber: 1.26,
            volumeAbbreviated: "15.5M",
          },
          {
            symbol: "GOOG",
            last: "150.05",
            changeAsNumber: -0.05,
            changePercentAsNumber: -0.03,
            volumeAbbreviated: "5.2M",
          },
          {
            symbol: "TSLA",
            last: "250.00",
            changeAsNumber: 10.0,
            changePercentAsNumber: 4.16,
            volumeAbbreviated: "8M",
          }, // ìƒˆë¡œìš´ ì¢…ëª© ì¶”ê°€
        ]);
      }, 3000);
    </script>
  </body>
</html>
