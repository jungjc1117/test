<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Kiwoom 장중투자자별매매상위요청</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background: white;
        /* padding: 20px; */
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #333;
      }
      #timestamp {
        text-align: right;
        font-size: 0.9em;
        color: #777;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9em;
      }
      th,
      td {
        /* padding: 12px; */
        text-align: right;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
        color: #555;
      }
      tr:hover {
        background-color: #f9f9f9;
      }
      .loading {
        text-align: center;
        color: #888;
      }
      .error {
        color: red;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="timestamp"></div>
      <div id="output"></div>
    </div>

    <script>
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      const formattedDate = `${year}${month}${day}`;

      const accessParams = {
        grant_type: "client_credentials",
        appkey: "oJ5S3eaEUVsSaxPX7vkiOPjOI9_yvkFGm3lwAkd_fAg",
        secretkey: "lA1nom_3Ql1TX1rUpppvwhRJBuEQ44cECAYn7lCGgps",
      };

      const amountKospi = {
        mrkt_tp: "001",
        mang_stk_incls: "1",
        stex_tp: "3",
      };

      const amountKosdaq = {
        mrkt_tp: "101",
        mang_stk_incls: "1",
        stex_tp: "3",
      };

      const KospiQuantity = {
        mrkt_tp: "001",
        sort_tp: "3",
        mang_stk_incls: "16",
        crd_tp: "0",
        trde_qty_tp: "0",
        pric_tp: "0",
        trde_prica_tp: "0",
        mrkt_open_tp: "0",
        stex_tp: "3",
      };

      const KosdaqQuantity = {
        mrkt_tp: "101",
        sort_tp: "3",
        mang_stk_incls: "16",
        crd_tp: "0",
        trde_qty_tp: "0",
        pric_tp: "0",
        trde_prica_tp: "0",
        mrkt_open_tp: "0",
        stex_tp: "3",
      };

      const KospiProgram = {
        dt: formattedDate, //YYYYMMDD
        mrkt_tp: "P00101", //P00101:코스피, P10102:코스닥
        stex_tp: "3", // 1:KRX, 2:NXT 3.통합
      };

      const KosdaqProgram = {
        dt: formattedDate, //YYYYMMDD
        mrkt_tp: "P10102", //P00101:코스피, P10102:코스닥
        stex_tp: "3", //1:KRX, 2:NXT 3.통합
      };

      const OrgKospiBuy = {
        trde_tp: "1",
        mrkt_tp: "001",
        orgn_tp: "9999",
      };

      const OrgKosdaqBuy = {
        trde_tp: "1",
        mrkt_tp: "101",
        orgn_tp: "9999",
      };

      const OrgKospiSell = {
        trde_tp: "2",
        mrkt_tp: "001",
        orgn_tp: "9999",
      };

      const OrgKosdaqSell = {
        trde_tp: "2",
        mrkt_tp: "101",
        orgn_tp: "9999",
      };

      async function fetchToken() {
        const url = "https://mockapi.kiwoom.com/oauth2/token";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json;charset=UTF-8" },
          body: JSON.stringify(accessParams),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data.token;
      }

      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function fetchPricaKospi(token) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10032",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(amountKospi),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return (data.trde_prica_upper || []).map((item) => ({
          stk_cd: item.stk_cd.replace(/^A|_AL$/, ""),
          stk_nm: item.stk_nm,
          cur_prc: Math.abs(parseInt(item.cur_prc)),
          flu_rt: parseFloat(item.flu_rt),
          trde_qty: parseInt(item.now_trde_qty),
        }));
      }

      async function fetchPricaKosdaq(token) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10032",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(amountKosdaq),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return (data.trde_prica_upper || []).map((item) => ({
          stk_cd: item.stk_cd.replace(/^A|_AL$/, ""),
          stk_nm: item.stk_nm,
          cur_prc: Math.abs(parseInt(item.cur_prc)),
          flu_rt: parseFloat(item.flu_rt),
          trde_qty: parseInt(item.now_trde_qty),
        }));
      }

      async function fetchKospiQuantity(token) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10030",
            "cont-yn": "Y",
            "next-key": "",
          },
          body: JSON.stringify(KospiQuantity),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        const rawGroupData = data.tdy_trde_qty_upper || [];

        const formattedData = rawGroupData.map((item) => ({
          stk_cd: item.stk_cd.replace(/[^0-9]/g, ""),
          stk_nm: item.stk_nm,
          cur_prc: Math.abs(item.cur_prc),
          flu_rt: parseFloat(item.flu_rt).toFixed(2),
          trde_qty: item.trde_qty,
        }));

        return formattedData;
      }

      async function fetchKosdaqQuantity(token) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10030",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(KosdaqQuantity),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        const rawGroupData = data.tdy_trde_qty_upper || [];

        const formattedData = rawGroupData.map((item) => ({
          stk_cd: item.stk_cd.replace(/[^0-9]/g, ""),
          stk_nm: item.stk_nm,
          cur_prc: Math.abs(item.cur_prc),
          flu_rt: parseFloat(item.flu_rt).toFixed(2),
          trde_qty: item.trde_qty,
        }));

        return formattedData;
      }

      async function fetchInvestorData(token, params) {
        const url = "https://mockapi.kiwoom.com/api/dostk/rkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka10065",
            "cont-yn": "N",
            "next-key": "",
          },
          body: JSON.stringify(params),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data.opmr_invsr_trde_upper || [];
      }

      async function fetchProgram(token, params) {
        const url = "https://mockapi.kiwoom.com/api/dostk/stkinfo";
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=UTF-8",
            authorization: `Bearer ${token}`,
            "api-id": "ka90004",
            "cont-yn": "Y",
            "next-key": "",
          },
          body: JSON.stringify(params),
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        const rawGroupData = data.stk_prm_trde_prst || [];

        const formattedData = rawGroupData.map((item) => ({
          stk_cd: item.stk_cd.replace(/[^0-9]/g, ""),
          stk_nm: item.stk_nm,
          cur_prc: Math.abs(item.cur_prc),
          netprps_prica: parseFloat(item.netprps_prica).toFixed(),
        }));

        return formattedData;
      }

      // New function to fetch outstanding shares data
      async function fetchOutstandingShares() {
        const url = "data.json";
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(
            `Failed to fetch outstanding shares data: ${res.status}`
          );
        }
        const data = await res.json();
        return data;
      }

      function updateTimestamp(message = "") {
        const now = new Date();
        document.getElementById(
          "timestamp"
        ).innerText = `${message} 최종 업데이트: ${now.toLocaleTimeString()}`;
      }

      async function updateData() {
        try {
          updateTimestamp("업데이트 중... ");
          const token = await fetchToken();
          const mergedDataMap = new Map();

          // Fetch outstanding shares data first
          const outstandingSharesData = await fetchOutstandingShares();
          outstandingSharesData.forEach((item) => {
            const stkCd = item.종목코드;
            mergedDataMap.set(stkCd, {
              stk_cd: stkCd,
              stk_nm: "", // Name will be filled later
              outstandingShares: parseInt(item.주식수),
            });
          });

          // 프로그램 순매수 데이터
          const programKospiData = await fetchProgram(token, KospiProgram);
          programKospiData.forEach((item) => {
            const stkCd = item.stk_cd.replace(/[^0-9]/g, "");
            if (!mergedDataMap.has(stkCd)) {
              mergedDataMap.set(stkCd, {
                stk_cd: stkCd,
                stk_nm: item.stk_nm,
              });
            }
            mergedDataMap.get(stkCd).stk_nm = item.stk_nm;
            mergedDataMap.get(stkCd).Program = parseInt(item.netprps_prica);
          });
          await delay(2000);

          const programKosdaqData = await fetchProgram(token, KosdaqProgram);
          programKosdaqData.forEach((item) => {
            const stkCd = item.stk_cd.replace(/[^0-9]/g, "");
            if (!mergedDataMap.has(stkCd)) {
              mergedDataMap.set(stkCd, {
                stk_cd: stkCd,
                stk_nm: item.stk_nm,
              });
            }
            mergedDataMap.get(stkCd).stk_nm = item.stk_nm;
            mergedDataMap.get(stkCd).Program = parseInt(item.netprps_prica);
          });
          await delay(2000);

          // 투자자별 매매 데이터
          const orgBuyKospiData = await fetchInvestorData(token, OrgKospiBuy);
          orgBuyKospiData.forEach((item) => {
            const stkCd = item.stk_cd.replace(/[^0-9]/g, "");
            if (!mergedDataMap.has(stkCd)) {
              mergedDataMap.set(stkCd, {
                stk_cd: stkCd,
                stk_nm: item.stk_nm,
              });
            }
            mergedDataMap.get(stkCd).stk_nm = item.stk_nm;
            mergedDataMap.get(stkCd).OrgNetBuy = parseInt(item.netslmt);
          });
          await delay(2000);

          const orgSellKospiData = await fetchInvestorData(token, OrgKospiSell);
          orgSellKospiData.forEach((item) => {
            const stkCd = item.stk_cd.replace(/[^0-9]/g, "");
            if (!mergedDataMap.has(stkCd)) {
              mergedDataMap.set(stkCd, {
                stk_cd: stkCd,
                stk_nm: item.stk_nm,
              });
            }
            mergedDataMap.get(stkCd).stk_nm = item.stk_nm;
            mergedDataMap.get(stkCd).OrgNetSell = parseInt(item.netslmt);
          });
          await delay(2000);

          const orgBuyKosdaqData = await fetchInvestorData(token, OrgKosdaqBuy);
          orgBuyKosdaqData.forEach((item) => {
            const stkCd = item.stk_cd.replace(/[^0-9]/g, "");
            if (!mergedDataMap.has(stkCd)) {
              mergedDataMap.set(stkCd, {
                stk_cd: stkCd,
                stk_nm: item.stk_nm,
              });
            }
            mergedDataMap.get(stkCd).stk_nm = item.stk_nm;
            const currentBuy = mergedDataMap.get(stkCd).OrgNetBuy || 0;
            mergedDataMap.get(stkCd).OrgNetBuy =
              currentBuy + parseInt(item.netslmt);
          });
          await delay(2000);

          const orgSellKosdaqData = await fetchInvestorData(
            token,
            OrgKosdaqSell
          );
          orgSellKosdaqData.forEach((item) => {
            const stkCd = item.stk_cd.replace(/[^0-9]/g, "");
            if (!mergedDataMap.has(stkCd)) {
              mergedDataMap.set(stkCd, {
                stk_cd: stkCd,
                stk_nm: item.stk_nm,
              });
            }
            mergedDataMap.get(stkCd).stk_nm = item.stk_nm;
            const currentSell = mergedDataMap.get(stkCd).OrgNetSell || 0;
            mergedDataMap.get(stkCd).OrgNetSell =
              currentSell + parseInt(item.netslmt);
          });
          await delay(2000);

          // 거래대금 데이터
          const pricaKospiData = await fetchPricaKospi(token);
          pricaKospiData.forEach((item) => {
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem) {
              Object.assign(existingItem, {
                cur_prc: item.cur_prc,
                flu_rt: item.flu_rt,
              });
            } else {
              mergedDataMap.set(item.stk_cd, item);
            }
          });
          await delay(2000);

          const pricaKosdaqData = await fetchPricaKosdaq(token);
          pricaKosdaqData.forEach((item) => {
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem) {
              Object.assign(existingItem, {
                cur_prc: item.cur_prc,
                flu_rt: item.flu_rt,
              });
            } else {
              mergedDataMap.set(item.stk_cd, item);
            }
          });
          await delay(2000);

          // 거래량 데이터
          const quantityKospiData = await fetchKospiQuantity(token);
          quantityKospiData.forEach((item) => {
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem) {
              Object.assign(existingItem, {
                cur_prc: item.cur_prc,
                flu_rt: item.flu_rt,
                trde_qty: item.trde_qty,
              });
            } else {
              mergedDataMap.set(item.stk_cd, item);
            }
          });
          await delay(2000);

          const quantityKosdaqData = await fetchKosdaqQuantity(token);
          quantityKosdaqData.forEach((item) => {
            const existingItem = mergedDataMap.get(item.stk_cd);
            if (existingItem) {
              Object.assign(existingItem, {
                cur_prc: item.cur_prc,
                flu_rt: item.flu_rt,
                trde_qty: item.trde_qty,
              });
            } else {
              mergedDataMap.set(item.stk_cd, item);
            }
          });

          // 최종 데이터 계산 및 정렬
          const finalData = Array.from(mergedDataMap.values()).map((item) => {
            const programNet = parseInt(item.Program) || 0;
            const orgNetBuy = parseInt(item.OrgNetBuy) || 0;
            const orgNetSell = parseInt(item.OrgNetSell) || 0;

            const totalOrgNet = orgNetBuy + orgNetSell;

            const programAmountInHunds = programNet / 100;
            const orgAmountInHundMs =
              (totalOrgNet * (item.cur_prc || 0)) / 100000000;

            // Calculate Market Cap (시가총액)
            const marketCap =
              item.cur_prc && item.outstandingShares
                ? (item.cur_prc * item.outstandingShares) / 100000
                : 0;

            const totalForSorting = programAmountInHunds + orgAmountInHundMs;

            return {
              ...item,
              programAmountInHunds: programAmountInHunds,
              orgAmountInHundMs: orgAmountInHundMs,
              totalForSorting: totalForSorting,
              marketCap: marketCap,
            };
          });

          // 기관 순매수대금(org)을 기준으로 내림차순 정렬
          finalData.sort((a, b) => b.totalForSorting - a.totalForSorting);

          renderTable(finalData);
          updateTimestamp();
        } catch (e) {
          console.error("Error during updateData:", e);
          document.getElementById(
            "output"
          ).innerHTML = `<div class="error">데이터 로딩 중 에러가 발생했습니다: ${e.message}</div>`;
        }
      }

      function renderTable(dataList) {
        const table = document.createElement("table");
        table.innerHTML = `
    <thead>
      <tr>
        <th>종목코드</th>
        <th>종목명</th>
        <th>현재가</th>
        <th>등락률</th>
        <th>거래량</th>
        <th>프로그램(억)</th>
        <th>기관(억)</th>
        <th>시가총액(억)</th>
      </tr>
    </thead>
    <tbody>
      ${dataList
        .map((item) => {
          const fluRt = parseFloat(item.flu_rt);
          const formattedFluRt = !isNaN(fluRt) ? fluRt.toFixed(2) : "";
          const programAmount = (item.programAmountInHunds ?? 0).toFixed(0);
          const orgAmount = (item.orgAmountInHundMs ?? 0).toFixed(0);
          const marketCap = (item.marketCap ?? 0).toFixed(0);

          return `
            <tr>
              <td>${item.stk_cd}</td>
              <td>${item.stk_nm}</td>
              <td>${item.cur_prc !== undefined ? item.cur_prc : ""}</td>
              <td>${formattedFluRt}</td>
              <td>${item.trde_qty !== undefined ? item.trde_qty : ""}</td>
              <td>${programAmount}</td>
              <td>${orgAmount}</td>
              <td>${marketCap}</td>
            </tr>
          `;
        })
        .join("")}
    </tbody>
  `;
        document.getElementById("output").innerHTML = "";
        document.getElementById("output").appendChild(table);
      }

      updateData();
      setInterval(updateData, 60000);
    </script>
  </body>
</html>
